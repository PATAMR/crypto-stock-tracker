<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaTrade v6.0 - Free Real Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes flash-green { 0% { color: #10B981; } 100% { color: white; } }
        @keyframes flash-red { 0% { color: #EF4444; } 100% { color: white; } }
        .updated-up { animation: flash-green 1s ease-out; }
        .updated-down { animation: flash-red 1s ease-out; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        .active-tab { border-bottom: 2px solid #3B82F6; color: #3B82F6; }
        .inactive-tab { color: #9CA3AF; }
        .asset-btn.active { background-color: #2563EB; color: white; border-color: #3B82F6; }

        .signal-badge { padding: 4px 12px; border-radius: 4px; font-weight: 800; font-size: 0.8rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .signal-buy { background-color: rgba(16, 185, 129, 0.2); color: #34D399; border: 1px solid #10B981; }
        .signal-sell { background-color: rgba(239, 68, 68, 0.2); color: #F87171; border: 1px solid #EF4444; }
        .signal-hold { background-color: rgba(245, 158, 11, 0.2); color: #FBBF24; border: 1px solid #F59E0B; }

        /* Chatbot Styling */
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .chat-button { 
            width: 60px; height: 60px; border-radius: 50%; 
            background: linear-gradient(135deg, #2563EB, #1E40AF); 
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.5);
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: transform 0.2s;
        }
        .chat-button:hover { transform: scale(1.1); }
        
        .chat-window {
            width: 380px; height: 600px; background: #111827; 
            border: 1px solid #374151; border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            margin-bottom: 16px; display: flex; flex-direction: column;
            transform-origin: bottom right; transition: all 0.3s ease;
            opacity: 0; transform: scale(0.9) translateY(20px); pointer-events: none;
        }
        .chat-window.open { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { max-width: 90%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; position: relative; }
        .msg-bot { background: #1F2937; color: #E5E7EB; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #374151; }
        .msg-user { background: #2563EB; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        .bot-card { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-top: 8px; border-left: 4px solid #3B82F6; }
        .bot-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9em; }
        .bot-label { color: #9CA3AF; font-size: 0.8em; text-transform: uppercase; font-weight: bold; }
        .bot-val { color: white; font-weight: 600; }
        .bot-justification { font-style: italic; color: #D1D5DB; font-size: 0.85em; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }

        .typing-dot { display: inline-block; width: 6px; height: 6px; background: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite both; margin: 0 2px; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-950 text-white font-sans min-h-screen p-4 md:p-6">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6 pb-20">
        
        <!-- GAUCHE : Actifs -->
        <div class="lg:col-span-1 bg-gray-900 rounded-xl border border-gray-800 p-4 flex flex-col h-[85vh] sticky top-4">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-blue-500 flex items-center gap-2">
                    <i data-lucide="activity"></i> NovaTrade
                </h1>
                <p class="text-xs text-gray-500 mt-1">v6.0 Free Real Data</p>
            </div>

            <div class="flex mb-4 border-b border-gray-700">
                <button onclick="switchCategory('crypto')" id="tab-crypto" class="flex-1 pb-2 text-sm font-medium active-tab transition">Crypto</button>
                <button onclick="switchCategory('stocks')" id="tab-stocks" class="flex-1 pb-2 text-sm font-medium inactive-tab transition">Actions</button>
            </div>

            <div id="asset-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>
            
            <div id="data-source-indicator" class="mt-4 pt-4 border-t border-gray-800 text-xs text-center text-gray-500">
                <p>Crypto: Binance (Live)</p>
                <p>Actions: <span class="text-green-500 font-bold">Yahoo Finance (Proxy)</span></p>
            </div>
        </div>

        <!-- CENTRE : Graphiques -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- Header Actif -->
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <h2 id="current-symbol" class="text-4xl font-bold">BTC</h2>
                        <p id="current-name" class="text-gray-400 text-sm">Bitcoin</p>
                    </div>
                    <div class="text-right">
                        <div id="main-price" class="text-4xl font-bold tracking-tight">--- ‚Ç¨</div>
                        <div id="main-change" class="text-lg font-medium mt-1">--- %</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-6 relative z-10">
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Haut 24h</span>
                        <div id="stat-high" class="font-mono text-green-400">---</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Bas 24h</span>
                        <div id="stat-low" class="font-mono text-red-400">---</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Volume</span>
                        <div id="stat-vol" class="font-mono text-blue-400">---</div>
                    </div>
                </div>
            </div>

            <!-- Graphique -->
            <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 min-h-[300px]">
                <div class="relative h-64 w-full"><canvas id="mainChart"></canvas></div>
                <p class="text-[10px] text-gray-600 text-center mt-2" id="chart-disclaimer"></p>
            </div>

            <!-- Analyse Expert -->
            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <div class="bg-gray-800/50 p-4 border-b border-gray-700 flex items-center justify-between">
                    <h3 class="font-bold flex items-center gap-2 text-indigo-400">
                        <i data-lucide="brain-circuit"></i> Analyse Fondamentale
                    </h3>
                    <span class="text-xs text-gray-500 uppercase tracking-wider">M√©thode Gave / IDL</span>
                </div>
                <div class="p-5">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-indigo-900/50 flex items-center justify-center text-indigo-400 border border-indigo-500/30">
                                <i data-lucide="glasses" size="24"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span id="analysis-signal" class="signal-badge signal-hold">...</span>
                                <span class="text-xs text-gray-500">Horizon: Long Terme</span>
                            </div>
                            <p id="analysis-text" class="text-gray-300 text-sm leading-relaxed italic">Chargement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DROITE : News -->
        <div class="lg:col-span-1 flex flex-col gap-6">
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 h-full flex flex-col">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-yellow-500">
                    <i data-lucide="newspaper" size="20"></i> Presse Financi√®re
                </h3>
                <div id="news-feed" class="space-y-3 overflow-y-auto custom-scroll flex-1 pr-2"></div>
            </div>
        </div>
    </div>

    <!-- WIDGET CHATBOT INTELLIGENT -->
    <div class="chat-widget">
        <div class="chat-window" id="chatWindow">
            <div class="bg-blue-900 p-4 border-b border-gray-700 rounded-t-xl flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center shadow-lg">
                        <i data-lucide="bot" size="18" class="text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm">NovaBot v2.0</h4>
                        <span class="text-xs text-blue-200 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-400 rounded-full inline-block animate-pulse"></span> IA Active
                        </span>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-blue-200 hover:text-white"><i data-lucide="x" size="20"></i></button>
            </div>
            
            <div class="chat-messages custom-scroll" id="chatMessages">
                <div class="msg msg-bot">
                    Bonjour ! Je suis connect√© aux march√©s r√©els via Yahoo Finance. üåê<br><br>
                    Essayez :<br>
                    - "Combien de Tesla acheter avec 2000‚Ç¨ ?"<br>
                    - "Est-ce le moment pour Bitcoin ?"
                </div>
            </div>

            <div class="p-3 border-t border-gray-700 bg-gray-800 rounded-b-xl">
                <form id="chatForm" onsubmit="handleChatSubmit(event)" class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Ex: Acheter du BTC maintenant ?" autocomplete="off"
                           class="flex-1 bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition shadow-lg">
                        <i data-lucide="send" size="18"></i>
                    </button>
                </form>
            </div>
        </div>

        <button onclick="toggleChat()" class="chat-button">
            <i data-lucide="message-circle" size="32" class="text-white"></i>
        </button>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ACTIFS ---
        const CRYPTO_ASSETS = [
            { symbol: 'BTC', pair: 'BTCEUR', name: 'Bitcoin', aliases: ['bitcoin', 'btc'] },
            { symbol: 'ETH', pair: 'ETHEUR', name: 'Ethereum', aliases: ['ethereum', 'eth'] },
            { symbol: 'SOL', pair: 'SOLEUR', name: 'Solana', aliases: ['solana', 'sol'] },
            { symbol: 'BNB', pair: 'BNBEUR', name: 'Binance Coin', aliases: ['bnb'] },
            { symbol: 'XRP', pair: 'XRPEUR', name: 'Ripple', aliases: ['xrp'] }
        ];

        const STOCK_ASSETS = [
            { symbol: 'AAPL', name: 'Apple Inc.', aliases: ['apple', 'aapl', 'iphone'] },
            { symbol: 'MSFT', name: 'Microsoft Corp', aliases: ['microsoft', 'msft', 'windows'] },
            { symbol: 'GOOGL', name: 'Alphabet Inc.', aliases: ['google', 'googl', 'alphabet'] },
            { symbol: 'TSLA', name: 'Tesla Inc.', aliases: ['tesla', 'tsla', 'musk'] },
            { symbol: 'NVDA', name: 'NVIDIA Corp', aliases: ['nvidia', 'nvda', 'ia'] },
            { symbol: 'META', name: 'Meta Platforms', aliases: ['meta', 'facebook'] },
            { symbol: 'AMZN', name: 'Amazon.com', aliases: ['amazon', 'amzn'] }
        ];

        // --- ANALYSE GAVE ---
        const EXPERT_ANALYSIS = {
            'BTC': { signal: 'ACHETER', risk: 0.05, text: "R√©serve de valeur hors syst√®me bancaire. Indispensable." },
            'ETH': { signal: 'CONSERVER', risk: 0.03, text: "Corr√©lation √©lev√©e avec le Nasdaq. Utile mais cyclique." },
            'SOL': { signal: 'VENDRE', risk: 0, text: "Actif trop centralis√© et sp√©culatif. Risque de liquidit√©." },
            'AAPL': { signal: 'CONSERVER', risk: 0.04, text: "Pricing power fort, mais d√©pendance √† la Chine critique." },
            'MSFT': { signal: 'ACHETER', risk: 0.06, text: "Infrastructure du monde num√©rique. Rente de situation quasi-parfaite." },
            'TSLA': { signal: 'VENDRE', risk: 0, text: "Marges automobiles sous pression. Valorisation de r√™ve." },
            'NVDA': { signal: 'CONSERVER', risk: 0.03, text: "Bulle IA possible. Fondamentaux excellents mais prix excessif." },
            'META': { signal: 'ACHETER', risk: 0.04, text: "Mon√©tisation incroyable de l'attention humaine. Cash machine." },
            'AMZN': { signal: 'ACHETER', risk: 0.05, text: "AWS est l'infrastructure du web. Position dominante." },
            'DEFAULT': { signal: 'NEUTRE', risk: 0.02, text: "Prudence requise. Privil√©giez le cash." }
        };

        const NEWS = [
            { title: "Taux Fed : Powell reste ferme", source: "Bloomberg", impact: "Neutre" },
            { title: "Chine : Ralentissement confirm√©", source: "Financial Times", impact: "N√©gatif" },
            { title: "Tech : R√©sultats sup√©rieurs aux attentes", source: "Reuters", impact: "Positif" },
            { title: "Inflation Zone Euro : 2.4%", source: "Les √âchos", impact: "Positif" }
        ];

        // --- VARIABLES GLOBALES ---
        let currentCategory = 'crypto';
        let currentAsset = CRYPTO_ASSETS[0];
        let currentPriceCache = 0; 
        let myChart = null;
        let defaultCapital = 10000;

        // --- MOTEUR CHATBOT INTELLIGENT ---
        function toggleChat() {
            document.getElementById('chatWindow').classList.toggle('open');
        }

        function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            
            addMessage('user', text);
            input.value = '';
            
            const loadingId = addMessage('bot', '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>');
            
            setTimeout(() => {
                document.getElementById(loadingId).remove();
                const response = generateSmartResponse(text);
                addMessage('bot', response);
            }, 800);
        }

        function addMessage(role, html) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `msg ${role === 'user' ? 'msg-user' : 'msg-bot'}`;
            div.innerHTML = html;
            const c = document.getElementById('chatMessages');
            c.appendChild(div);
            c.scrollTop = c.scrollHeight;
            return id;
        }

        // --- CERVEAU DU CHATBOT ---
        function generateSmartResponse(text) {
            const lower = text.toLowerCase();
            let asset = [...CRYPTO_ASSETS, ...STOCK_ASSETS].find(a => 
                a.aliases.some(alias => lower.includes(alias)) || lower.includes(a.symbol.toLowerCase())
            );
            if (!asset && (lower.includes('il') || lower.includes('ce'))) asset = currentAsset;

            const amountMatch = text.match(/(\d+([.,]\d+)?)\s*(‚Ç¨|euro|euros|k)/i);
            let customCapital = amountMatch ? parseFloat(amountMatch[1].replace(',','.')) : null;
            if(text.includes('k') && customCapital) customCapital *= 1000;

            const analysis = asset ? (EXPERT_ANALYSIS[asset.symbol] || EXPERT_ANALYSIS.DEFAULT) : EXPERT_ANALYSIS.DEFAULT;

            if (lower.includes('combien') || lower.includes('montant') || lower.includes('investir') || lower.includes('taille')) {
                if (!asset) return "Pr√©cisez l'actif. Ex: 'Combien investir sur Tesla ?'";
                const cap = customCapital || defaultCapital;
                const allocAmount = analysis.signal === 'VENDRE' ? 0 : cap * analysis.risk;
                const color = analysis.signal === 'ACHETER' ? 'text-green-400' : (analysis.signal === 'VENDRE' ? 'text-red-400' : 'text-yellow-400');
                
                return `<strong>üí∞ Calcul de Position (${asset.symbol})</strong>
                        <div class="bot-card">
                            <div class="bot-row"><span class="bot-label">Capital R√©f</span><span class="bot-val">${cap} ‚Ç¨</span></div>
                            <div class="bot-row"><span class="bot-label">Risque Allou√©</span><span class="bot-val">${(analysis.risk * 100)}%</span></div>
                            <div class="bot-row"><span class="bot-label">Montant Conseill√©</span><span class="bot-val text-xl ${color}">${allocAmount.toFixed(0)} ‚Ç¨</span></div>
                            <div class="bot-justification">${analysis.text}</div>
                        </div>`;
            }
            if (lower.includes('quand') || lower.includes('moment') || lower.includes('temps') || lower.includes('maintenant')) {
                if (!asset) return "De quel actif parlez-vous ? Ex: 'Est-ce le bon moment pour BTC ?'";
                const signalColor = analysis.signal === 'ACHETER' ? 'bot-rec-buy' : (analysis.signal === 'VENDRE' ? 'bot-rec-sell' : 'text-yellow-400');
                return `<strong>‚è∞ Analyse Timing (${asset.symbol})</strong>
                        <div class="bot-card">
                            <div class="bot-row"><span class="bot-label">Signal Gave</span><span class="bot-val ${signalColor}">${analysis.signal}</span></div>
                            <div class="bot-row"><span class="bot-label">Tendance Fond.</span><span class="bot-val">${analysis.signal === 'ACHETER' ? 'Haussi√®re' : 'Fragile'}</span></div>
                            <div class="bot-justification">${analysis.text}</div>
                        </div>`;
            }
            if (lower.includes('strat√©gie') || lower.includes('r√©partition') || lower.includes('diversifier')) {
                return `<strong>üìä Allocation Strat√©gique Type</strong>
                        <div class="bot-card">
                            <div class="bot-row"><span class="bot-label">Actions Qualit√© (MSFT...)</span><span class="bot-val">40%</span></div>
                            <div class="bot-row"><span class="bot-label">Or / Bitcoin</span><span class="bot-val">20%</span></div>
                            <div class="bot-row"><span class="bot-label">Obligations / Cash</span><span class="bot-val">30%</span></div>
                            <div class="bot-row"><span class="bot-label">Sp√©culatif</span><span class="bot-val">10%</span></div>
                            <div class="bot-justification">L'objectif est l'antifragilit√©.</div>
                        </div>`;
            }
            if (asset) {
                return `<strong>üîé Analyse Rapide : ${asset.name}</strong>
                        <div class="bot-card">
                            <div class="bot-row"><span class="bot-label">Signal</span><span class="bot-val">${analysis.signal}</span></div>
                            <div class="bot-justification">${analysis.text}</div>
                        </div>`;
            }
            return "Je n'ai pas compris. Essayez : 'Analyse Tesla' ou 'Combien de BTC avec 1000‚Ç¨ ?'";
        }

        // --- FETCHING DATA (REAL) ---
        
        async function fetchData() {
            document.getElementById('current-symbol').innerText = currentAsset.symbol;
            document.getElementById('current-name').innerText = currentAsset.name;
            
            const ana = EXPERT_ANALYSIS[currentAsset.symbol] || EXPERT_ANALYSIS.DEFAULT;
            const sig = document.getElementById('analysis-signal');
            sig.innerText = ana.signal;
            sig.className = `signal-badge ${ana.signal === 'ACHETER' ? 'signal-buy' : (ana.signal === 'VENDRE' ? 'signal-sell' : 'signal-hold')}`;
            document.getElementById('analysis-text').innerText = ana.text;

            if (currentCategory === 'crypto') {
                document.getElementById('chart-disclaimer').innerText = "";
                await fetchBinance(currentAsset.pair);
            } else {
                document.getElementById('chart-disclaimer').innerText = "* Donn√©es Yahoo Finance en temps r√©el (via proxy). D√©lai possible.";
                await fetchYahoo(currentAsset.symbol);
            }
        }

        async function fetchBinance(symbol) {
            try {
                const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
                const data = await res.json();
                currentPriceCache = parseFloat(data.lastPrice);
                updateUI(data.lastPrice, data.priceChangePercent, data.highPrice, data.lowPrice, data.volume);
                
                const kline = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=24`);
                const kData = await kline.json();
                renderChart(kData.map(d => new Date(d[0]).getHours() + 'h'), kData.map(d => parseFloat(d[4])));
            } catch(e) { console.error(e); }
        }

        // üî• NO CLES REQUISES - YAHOO FINANCE VIA PROXY "ALLORIGINS" üî•
        async function fetchYahoo(symbol) {
            try {
                // Proxy pour √©viter CORS bloquant
                const proxyUrl = 'https://api.allorigins.win/get?url=';
                const targetUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=60m&range=1d&_=${new Date().getTime()}`);
                
                const response = await fetch(proxyUrl + targetUrl);
                const wrapper = await response.json();
                
                if (!wrapper.contents) throw new Error("Proxy Error");
                const data = JSON.parse(wrapper.contents);
                
                if (!data.chart || !data.chart.result) throw new Error("Yahoo Data Error");
                
                const result = data.chart.result[0];
                const meta = result.meta;
                const quotes = result.indicators.quote[0];
                
                const price = meta.regularMarketPrice;
                const prevClose = meta.chartPreviousClose;
                const changePercent = ((price - prevClose) / prevClose) * 100;
                
                currentPriceCache = price;
                updateUI(price, changePercent, meta.regularMarketDayHigh, meta.regularMarketDayLow, meta.regularMarketVolume); // Yahoo donne le volume USD parfois
                
                // Chart Construction
                const timestamps = result.timestamp;
                const closes = quotes.close;
                
                // Filter out null values (market closed hours sometimes yield nulls)
                const cleanData = timestamps.map((t, i) => ({ t, c: closes[i] })).filter(d => d.c != null);
                
                // Prend les 24 derniers points dispos ou tout le range
                const chartData = cleanData.slice(-24); 
                const labels = chartData.map(d => {
                    const date = new Date(d.t * 1000);
                    return date.getHours() + 'h';
                });
                const values = chartData.map(d => d.c);
                
                renderChart(labels, values);

            } catch (e) {
                console.error("Yahoo Fetch Error", e);
                updateUI(0, 0, 0, 0, 0);
                renderChart([], []);
            }
        }

        function updateUI(p, c, h, l, v) {
            const priceEl = document.getElementById('main-price');
            const val = typeof p === 'string' ? parseFloat(p) : p;
            priceEl.innerText = isNaN(val) ? '--- ‚Ç¨' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val); // Actions US en USD
            if(currentCategory === 'crypto') priceEl.innerText = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(val);
            
            const changeEl = document.getElementById('main-change');
            const chg = parseFloat(c);
            changeEl.innerText = isNaN(chg) ? '--- %' : (chg>0?'+':'') + chg.toFixed(2) + '%';
            changeEl.className = `text-lg font-medium mt-1 ${chg>=0 ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('stat-high').innerText = isNaN(parseFloat(h)) ? '---' : parseFloat(h).toFixed(2);
            document.getElementById('stat-low').innerText = isNaN(parseFloat(l)) ? '---' : parseFloat(l).toFixed(2);
            
            let volStr = v > 1000000 ? (v/1000000).toFixed(2)+'M' : (v/1000).toFixed(2)+'k';
            if(!v) volStr = "N/A";
            document.getElementById('stat-vol').innerText = volStr;
        }

        function renderChart(lbls, data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();
            const isUp = data.length > 0 && data[data.length-1] >= data[0];
            const col = isUp ? '#10B981' : '#EF4444';
            const grad = ctx.createLinearGradient(0,0,0,300);
            grad.addColorStop(0, isUp ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: lbls, datasets: [{ data: data, borderColor: col, backgroundColor: grad, borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { position: 'right', grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } } }, interaction: { intersect: false, mode: 'index' } }
            });
        }

        function renderAssetList() {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';
            const list = currentCategory === 'crypto' ? CRYPTO_ASSETS : STOCK_ASSETS;
            list.forEach(asset => {
                const btn = document.createElement('button');
                const isActive = asset.symbol === currentAsset.symbol;
                btn.className = `asset-btn w-full text-left p-3 rounded-lg border border-gray-700 hover:bg-gray-800 transition flex justify-between items-center ${isActive ? 'active' : 'bg-gray-800/40 text-gray-300'}`;
                btn.onclick = () => { currentAsset = asset; renderAssetList(); fetchData(); };
                btn.innerHTML = `<div><div class="font-bold">${asset.symbol}</div><div class="text-xs opacity-70">${asset.name}</div></div>`;
                container.appendChild(btn);
            });
        }

        function renderNews() {
            const c = document.getElementById('news-feed');
            c.innerHTML = '';
            NEWS.forEach(n => {
                const color = n.impact === 'Positif' ? 'text-green-400' : (n.impact === 'N√©gatif' ? 'text-red-400' : 'text-gray-400');
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-3 rounded border-l-4 border-gray-600";
                div.style.borderColor = n.impact === 'Positif' ? '#10B981' : (n.impact === 'N√©gatif' ? '#EF4444' : '#9CA3AF');
                div.innerHTML = `<div class="flex justify-between text-xs text-gray-500 mb-1"><span class="text-blue-400">${n.source}</span></div><h4 class="text-sm font-medium text-gray-200 mb-1">${n.title}</h4><span class="text-xs ${color} font-bold uppercase">${n.impact}</span>`;
                c.appendChild(div);
            });
        }

        function switchCategory(c) { 
            currentCategory=c; 
            currentAsset = c==='crypto'?CRYPTO_ASSETS[0]:STOCK_ASSETS[0]; 
            document.getElementById('tab-crypto').className = c==='crypto'?'flex-1 pb-2 text-sm font-medium active-tab transition':'flex-1 pb-2 text-sm font-medium inactive-tab transition';
            document.getElementById('tab-stocks').className = c==='stocks'?'flex-1 pb-2 text-sm font-medium active-tab transition':'flex-1 pb-2 text-sm font-medium inactive-tab transition';
            renderAssetList();
            fetchData();
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAssetList();
            renderNews();
            fetchData();
            setInterval(fetchData, 10000); // Rafraichissement toutes les 10s
        });

    </script>
</body>
</html>
