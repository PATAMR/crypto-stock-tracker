<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaTrade v3.3 - Assistant IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes flash-green { 0% { color: #10B981; } 100% { color: white; } }
        @keyframes flash-red { 0% { color: #EF4444; } 100% { color: white; } }
        .updated-up { animation: flash-green 1s ease-out; }
        .updated-down { animation: flash-red 1s ease-out; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        .active-tab { border-bottom: 2px solid #3B82F6; color: #3B82F6; }
        .inactive-tab { color: #9CA3AF; }
        .asset-btn.active { background-color: #2563EB; color: white; border-color: #3B82F6; }

        .signal-badge { padding: 4px 12px; border-radius: 4px; font-weight: 800; font-size: 0.8rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .signal-buy { background-color: rgba(16, 185, 129, 0.2); color: #34D399; border: 1px solid #10B981; }
        .signal-sell { background-color: rgba(239, 68, 68, 0.2); color: #F87171; border: 1px solid #EF4444; }
        .signal-hold { background-color: rgba(245, 158, 11, 0.2); color: #FBBF24; border: 1px solid #F59E0B; }

        /* Styles du Chatbot */
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .chat-button { 
            width: 60px; height: 60px; border-radius: 50%; 
            background: linear-gradient(135deg, #2563EB, #1E40AF); 
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.5);
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: transform 0.2s;
        }
        .chat-button:hover { transform: scale(1.1); }
        
        .chat-window {
            width: 350px; height: 500px; background: #111827; 
            border: 1px solid #374151; border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            margin-bottom: 16px; display: flex; flex-direction: column;
            transform-origin: bottom right; transition: all 0.3s ease;
            opacity: 0; transform: scale(0.9) translateY(20px); pointer-events: none;
        }
        .chat-window.open { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; }
        .msg-bot { background: #1F2937; color: #E5E7EB; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #374151; }
        .msg-user { background: #2563EB; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .typing-dot { display: inline-block; width: 6px; height: 6px; background: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite both; margin: 0 2px; }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-950 text-white font-sans min-h-screen p-4 md:p-6">

    <!-- DASHBOARD PRINCIPAL -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6 pb-20">
        
        <!-- GAUCHE : Sélection des Actifs -->
        <div class="lg:col-span-1 bg-gray-900 rounded-xl border border-gray-800 p-4 flex flex-col h-[85vh] sticky top-4">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-blue-500 flex items-center gap-2">
                    <i data-lucide="activity"></i> NovaTrade
                </h1>
                <p class="text-xs text-gray-500 mt-1">v3.3 Assistant IA</p>
            </div>

            <div class="flex mb-4 border-b border-gray-700">
                <button onclick="switchCategory('crypto')" id="tab-crypto" class="flex-1 pb-2 text-sm font-medium active-tab transition">Crypto</button>
                <button onclick="switchCategory('stocks')" id="tab-stocks" class="flex-1 pb-2 text-sm font-medium inactive-tab transition">Actions</button>
            </div>

            <div id="asset-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>

            <div class="mt-4 pt-4 border-t border-gray-800 text-xs text-center text-gray-500">
                <p>Données Crypto: Binance API (Live)</p>
                <p>Données Actions: Simulation (Demo)</p>
            </div>
        </div>

        <!-- CENTRE : Graphiques et Analyse -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- En-tête Actif -->
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="trending-up" width="100" height="100"></i>
                </div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <h2 id="current-symbol" class="text-4xl font-bold">BTC</h2>
                        <p id="current-name" class="text-gray-400 text-sm">Bitcoin</p>
                    </div>
                    <div class="text-right">
                        <div id="main-price" class="text-4xl font-bold tracking-tight">--- €</div>
                        <div id="main-change" class="text-lg font-medium mt-1">--- %</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-6 relative z-10">
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Haut 24h</span>
                        <div id="stat-high" class="font-mono text-green-400">---</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Bas 24h</span>
                        <div id="stat-low" class="font-mono text-red-400">---</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Volume</span>
                        <div id="stat-vol" class="font-mono text-blue-400">---</div>
                    </div>
                </div>
            </div>

            <!-- Graphique -->
            <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 min-h-[300px]">
                <div class="relative h-64 w-full"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- Analyse Expert -->
            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <div class="bg-gray-800/50 p-4 border-b border-gray-700 flex items-center justify-between">
                    <h3 class="font-bold flex items-center gap-2 text-indigo-400">
                        <i data-lucide="brain-circuit"></i> Analyse Stratégique
                    </h3>
                    <span class="text-xs text-gray-500 uppercase tracking-wider">Méthode Gave / IDL</span>
                </div>
                <div class="p-5">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-indigo-900/50 flex items-center justify-center text-indigo-400 border border-indigo-500/30">
                                <i data-lucide="glasses" size="24"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span id="analysis-signal" class="signal-badge signal-hold">Analyse en cours...</span>
                                <span class="text-xs text-gray-500">Horizon: Long Terme</span>
                            </div>
                            <p id="analysis-text" class="text-gray-300 text-sm leading-relaxed italic">Chargement de l'analyse fondamentale...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DROITE : Actualités -->
        <div class="lg:col-span-1 flex flex-col gap-6">
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 h-full flex flex-col">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-yellow-500">
                    <i data-lucide="newspaper" size="20"></i> Presse Financière
                </h3>
                <div id="news-feed" class="space-y-3 overflow-y-auto custom-scroll flex-1 pr-2"></div>
            </div>
        </div>
    </div>

    <!-- WIDGET CHATBOT -->
    <div class="chat-widget">
        <!-- Fenêtre de chat -->
        <div class="chat-window" id="chatWindow">
            <!-- Header Chat -->
            <div class="bg-blue-900 p-4 border-b border-gray-700 rounded-t-xl flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                        <i data-lucide="bot" size="18" class="text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm">Nova Assistant</h4>
                        <span class="text-xs text-blue-200 flex items-center gap-1">
                            <span class="w-2 h-2 bg-green-400 rounded-full inline-block"></span> En ligne
                        </span>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-blue-200 hover:text-white"><i data-lucide="x" size="20"></i></button>
            </div>
            
            <!-- Corps Chat -->
            <div class="chat-messages custom-scroll" id="chatMessages">
                <div class="msg msg-bot">
                    Bonjour ! Je suis votre assistant financier Nova. Je peux analyser des actifs selon la méthode Gave. <br><br>
                    Essayez : "Que penses-tu de Tesla ?" ou "Faut-il acheter du Bitcoin ?"
                </div>
            </div>

            <!-- Input Chat -->
            <div class="p-3 border-t border-gray-700 bg-gray-800 rounded-b-xl">
                <form id="chatForm" onsubmit="handleChatSubmit(event)" class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Posez votre question..." 
                           class="flex-1 bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition">
                        <i data-lucide="send" size="18"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Bouton Flottant -->
        <button onclick="toggleChat()" class="chat-button">
            <i data-lucide="message-circle" size="32" class="text-white"></i>
        </button>
    </div>

    <script>
        // --- DONNÉES & CONFIGURATION ---
        lucide.createIcons();

        const CRYPTO_ASSETS = [
            { symbol: 'BTC', pair: 'BTCEUR', name: 'Bitcoin', aliases: ['bitcoin', 'btc'] },
            { symbol: 'ETH', pair: 'ETHEUR', name: 'Ethereum', aliases: ['ethereum', 'eth', 'ether'] },
            { symbol: 'SOL', pair: 'SOLEUR', name: 'Solana', aliases: ['solana', 'sol'] },
            { symbol: 'BNB', pair: 'BNBEUR', name: 'Binance Coin', aliases: ['binance', 'bnb'] },
            { symbol: 'XRP', pair: 'XRPEUR', name: 'Ripple', aliases: ['ripple', 'xrp'] }
        ];

        const STOCK_ASSETS = [
            { symbol: 'AAPL', name: 'Apple Inc.', basePrice: 175, aliases: ['apple', 'aapl', 'iphone'] },
            { symbol: 'MSFT', name: 'Microsoft Corp', basePrice: 380, aliases: ['microsoft', 'msft', 'windows'] },
            { symbol: 'GOOGL', name: 'Alphabet Inc.', basePrice: 140, aliases: ['google', 'googl', 'alphabet'] },
            { symbol: 'TSLA', name: 'Tesla Inc.', basePrice: 210, aliases: ['tesla', 'tsla', 'musk'] },
            { symbol: 'NVDA', name: 'NVIDIA Corp', basePrice: 600, aliases: ['nvidia', 'nvda', 'ia'] },
            { symbol: 'LVMH', name: 'LVMH', basePrice: 780, aliases: ['lvmh', 'luxe', 'vuitton'] }
        ];

        const EXPERT_ANALYSIS = {
            'BTC': { signal: 'ACHETER', text: "Refuge contre la destruction monétaire. Le 'pricing power' ultime." },
            'ETH': { signal: 'CONSERVER', text: "Forte corrélation Tech. Utile mais pas de la 'monnaie'." },
            'SOL': { signal: 'VENDRE', text: "Trop spéculatif et centralisé pour un portefeuille patrimonial." },
            'AAPL': { signal: 'CONSERVER', text: "Machine à cash, mais attention à la contraction des multiples si les taux montent." },
            'MSFT': { signal: 'ACHETER', text: "Monopole naturel digital. Antifragile." },
            'TSLA': { signal: 'VENDRE', text: "Valorisation de rêve. L'automobile est une industrie cyclique difficile." },
            'NVDA': { signal: 'CONSERVER', text: "Leader incontesté, mais tout le monde est déjà dessus. Prudence." },
            'LVMH': { signal: 'ACHETER', text: "Le moyen de jouer la richesse mondiale. Pricing power infini." },
            'DEFAULT': { signal: 'NEUTRE', text: "Restez liquide en l'absence de tendance claire." }
        };

        const NEWS = [
            { title: "La Fed maintient ses taux", source: "Financial Times", impact: "Neutre", url: "https://www.ft.com" },
            { title: "Inflation EU en baisse", source: "Les Échos", impact: "Positif", url: "https://www.lesechos.fr" },
            { title: "Stimulus Chine annoncé", source: "Bloomberg", impact: "Positif", url: "https://www.bloomberg.com" },
            { title: "Le Yen plonge face au USD", source: "Reuters", impact: "Négatif", url: "https://www.reuters.com" },
            { title: "Déficit US inquiétant", source: "WSJ", impact: "Négatif", url: "https://www.wsj.com" }
        ];

        let currentCategory = 'crypto';
        let currentAsset = CRYPTO_ASSETS[0];
        let myChart = null;

        // --- LOGIQUE CHATBOT ---
        
        function toggleChat() {
            const win = document.getElementById('chatWindow');
            win.classList.toggle('open');
            if (win.classList.contains('open')) document.getElementById('chatInput').focus();
        }

        function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            addMessage('user', text);
            input.value = '';

            // Simulation délai de réponse
            showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                generateResponse(text);
            }, 1000);
        }

        function addMessage(sender, text) {
            const div = document.createElement('div');
            div.className = `msg ${sender === 'user' ? 'msg-user' : 'msg-bot'}`;
            div.innerHTML = text;
            const container = document.getElementById('chatMessages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'msg msg-bot';
            div.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            document.getElementById('chatMessages').appendChild(div);
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        function generateResponse(text) {
            const lowerText = text.toLowerCase();
            
            // Recherche de l'actif mentionné
            let foundAsset = null;
            let allAssets = [...CRYPTO_ASSETS, ...STOCK_ASSETS];
            
            for (let asset of allAssets) {
                if (asset.aliases.some(alias => lowerText.includes(alias)) || lowerText.includes(asset.symbol.toLowerCase())) {
                    foundAsset = asset;
                    break;
                }
            }

            if (foundAsset) {
                const analysis = EXPERT_ANALYSIS[foundAsset.symbol] || EXPERT_ANALYSIS['DEFAULT'];
                const signalColor = analysis.signal === 'ACHETER' ? 'text-green-400' : (analysis.signal === 'VENDRE' ? 'text-red-400' : 'text-yellow-400');
                
                // Simuler un prix si on n'a pas l'info sous la main
                const price = foundAsset.basePrice ? foundAsset.basePrice : "Donnée Live"; 
                
                const response = `
                    <strong>Analyse pour ${foundAsset.name} (${foundAsset.symbol}) :</strong><br>
                    Signal : <span class="${signalColor} font-bold">${analysis.signal}</span><br>
                    <br>
                    <em>"${analysis.text}"</em>
                `;
                addMessage('bot', response);
            } else if (lowerText.includes('bonjour') || lowerText.includes('salut')) {
                addMessage('bot', "Bonjour ! Comment puis-je vous aider à investir aujourd'hui ?");
            } else if (lowerText.includes('aide')) {
                addMessage('bot', "Je peux analyser des actions (Apple, Tesla...) ou des cryptos (Bitcoin, Solana...). Donnez-moi juste un nom !");
            } else {
                addMessage('bot', "Je ne suis pas sûr de comprendre. Essayez de mentionner un actif précis comme 'Bitcoin' ou 'LVMH'.");
            }
        }

        // --- LOGIQUE PRINCIPALE (Similaire v3.2) ---

        function init() {
            renderAssetList();
            renderNews();
            fetchData();
            setInterval(fetchData, 5000);
        }

        function renderAssetList() {
            const container = document.getElementById('asset-list');
            container.innerHTML = '';
            const list = currentCategory === 'crypto' ? CRYPTO_ASSETS : STOCK_ASSETS;
            list.forEach(asset => {
                const btn = document.createElement('button');
                const isActive = asset.symbol === currentAsset.symbol;
                btn.className = `asset-btn w-full text-left p-3 rounded-lg border border-gray-700 hover:bg-gray-800 transition flex justify-between items-center ${isActive ? 'active' : 'bg-gray-800/40 text-gray-300'}`;
                btn.onclick = () => { currentAsset = asset; renderAssetList(); fetchData(); };
                btn.innerHTML = `<div><div class="font-bold">${asset.symbol}</div><div class="text-xs opacity-70">${asset.name}</div></div>`;
                container.appendChild(btn);
            });
        }

        function renderNews() {
            const c = document.getElementById('news-feed');
            c.innerHTML = '';
            NEWS.forEach(n => {
                const color = n.impact === 'Positif' ? 'text-green-400' : (n.impact === 'Négatif' ? 'text-red-400' : 'text-gray-400');
                const a = document.createElement('a');
                a.href = n.url; a.target = "_blank";
                a.className = "block bg-gray-800 p-3 rounded border-l-4 border-gray-600 hover:bg-gray-750 transition group";
                a.style.borderColor = n.impact === 'Positif' ? '#10B981' : (n.impact === 'Négatif' ? '#EF4444' : '#9CA3AF');
                a.innerHTML = `<div class="flex justify-between text-xs text-gray-500 mb-1"><span class="text-blue-400">${n.source}</span></div><h4 class="text-sm font-medium text-gray-200 mb-2">${n.title}</h4><span class="text-xs ${color} font-bold uppercase">${n.impact}</span>`;
                c.appendChild(a);
            });
            lucide.createIcons();
        }

        async function fetchData() {
            document.getElementById('current-symbol').innerText = currentAsset.symbol;
            document.getElementById('current-name').innerText = currentAsset.name;
            renderAnalysis(currentAsset.symbol);
            
            if (currentCategory === 'crypto') {
                try {
                    const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${currentAsset.pair}`);
                    const data = await res.json();
                    updateUI(data.lastPrice, data.priceChangePercent, data.highPrice, data.lowPrice, data.volume);
                    
                    const kline = await fetch(`https://api.binance.com/api/v3/klines?symbol=${currentAsset.pair}&interval=1h&limit=24`);
                    const kData = await kline.json();
                    renderChart(kData.map(d => new Date(d[0]).getHours() + 'h'), kData.map(d => parseFloat(d[4])));
                } catch(e) { console.log(e); }
            } else {
                // Simulation Stock
                const base = currentAsset.basePrice;
                const price = base + (Math.random() - 0.5) * (base * 0.02);
                updateUI(price, ((price-base)/base)*100, price*1.01, price*0.99, Math.floor(Math.random()*1000000));
                const labels = Array.from({length:24},(_,i)=>i+'h');
                let p=base; const prices=labels.map(()=>{ p+=(Math.random()-0.5)*(base*0.01); return p; }); prices[23]=price;
                renderChart(labels, prices);
            }
        }

        function updateUI(p, c, h, l, v) {
            const priceEl = document.getElementById('main-price');
            const val = parseFloat(p);
            priceEl.innerText = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(val);
            const changeEl = document.getElementById('main-change');
            const chg = parseFloat(c);
            changeEl.innerText = (chg>0?'+':'') + chg.toFixed(2) + '%';
            changeEl.className = `text-lg font-medium mt-1 ${chg>=0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('stat-high').innerText = parseFloat(h).toFixed(2);
            document.getElementById('stat-low').innerText = parseFloat(l).toFixed(2);
            let volStr = v > 1000000 ? (v/1000000).toFixed(2)+'M' : (v/1000).toFixed(2)+'k';
            document.getElementById('stat-vol').innerText = volStr;
        }

        function renderAnalysis(symbol) {
            const a = EXPERT_ANALYSIS[symbol] || EXPERT_ANALYSIS['DEFAULT'];
            const sig = document.getElementById('analysis-signal');
            sig.innerText = a.signal;
            document.getElementById('analysis-text').innerText = a.text;
            sig.className = 'signal-badge ' + (a.signal==='ACHETER'?'signal-buy':(a.signal==='VENDRE'?'signal-sell':'signal-hold'));
        }

        function renderChart(lbls, data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();
            const isUp = data[data.length-1] >= data[0];
            const col = isUp ? '#10B981' : '#EF4444';
            const grad = ctx.createLinearGradient(0,0,0,300);
            grad.addColorStop(0, isUp ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: lbls, datasets: [{ data: data, borderColor: col, backgroundColor: grad, borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { position: 'right', grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } } }, interaction: { intersect: false, mode: 'index' } }
            });
        }

        function switchCategory(c) { currentCategory=c; currentAsset = c==='crypto'?CRYPTO_ASSETS[0]:STOCK_ASSETS[0]; 
            document.getElementById('tab-crypto').className = c==='crypto'?'flex-1 pb-2 text-sm font-medium active-tab transition':'flex-1 pb-2 text-sm font-medium inactive-tab transition';
            document.getElementById('tab-stocks').className = c==='stocks'?'flex-1 pb-2 text-sm font-medium active-tab transition':'flex-1 pb-2 text-sm font-medium inactive-tab transition';
            init(); 
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
