<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaTrade v8.8 - Stability Patch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes flash-green { 0% { color: #10B981; } 100% { color: white; } }
        @keyframes flash-red { 0% { color: #EF4444; } 100% { color: white; } }
        .updated-up { animation: flash-green 1s ease-out; }
        .updated-down { animation: flash-red 1s ease-out; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        .active-tab { border-bottom: 2px solid #3B82F6; color: #3B82F6; }
        .inactive-tab { color: #9CA3AF; }
        .asset-btn.active { background-color: #2563EB; color: white; border-color: #3B82F6; }

        .signal-badge { padding: 4px 12px; border-radius: 4px; font-weight: 800; font-size: 0.8rem; letter-spacing: 0.05em; text-transform: uppercase; }
        .signal-buy { background-color: rgba(16, 185, 129, 0.2); color: #34D399; border: 1px solid #10B981; }
        .signal-sell { background-color: rgba(239, 68, 68, 0.2); color: #F87171; border: 1px solid #EF4444; }
        .signal-hold { background-color: rgba(245, 158, 11, 0.2); color: #FBBF24; border: 1px solid #F59E0B; }

        /* CHATBOT STYLING */
        .chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; align-items: flex-end; }
        
        .chat-button { 
            width: 64px; height: 64px; border-radius: 50%; 
            background: linear-gradient(135deg, #8B5CF6, #6D28D9); 
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.5);
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #A78BFA;
            z-index: 101;
        }
        .chat-button:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.7); }
        
        .chat-window {
            width: 350px; height: 500px; background: #111827; 
            border: 1px solid #4C1D95; border-radius: 16px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            margin-bottom: 16px; display: flex; flex-direction: column;
            transform-origin: bottom right; 
            transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            opacity: 0; transform: scale(0.9) translateY(20px); 
            visibility: hidden; pointer-events: none;
            overflow: hidden; position: relative;
        }
        .chat-window.open { opacity: 1; transform: scale(1) translateY(0); visibility: visible; pointer-events: auto; }
        
        .chat-header { background: linear-gradient(to right, #4C1D95, #6D28D9); padding: 12px 16px; border-bottom: 1px solid #5B21B6; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; background: #0f1420; }
        
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .msg-bot { background: #1F2937; color: #E5E7EB; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #374151; }
        .msg-user { background: #7C3AED; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        /* Bot Card */
        .bot-card { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-top: 8px; border-left: 4px solid #8B5CF6; }
        .bot-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9em; }
        .bot-label { color: #9CA3AF; font-size: 0.8em; text-transform: uppercase; font-weight: bold; }
        .bot-val { color: white; font-weight: 600; }
        .bot-justification { font-style: italic; color: #D1D5DB; font-size: 0.85em; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); }
        
        .typing-dot { display: inline-block; width: 6px; height: 6px; background: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite both; margin: 0 2px; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* AUTH MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: #1F2937; width: 90%; max-width: 400px; border-radius: 16px; border: 1px solid #374151; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative; animation: modalSlide 0.3s ease-out; }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HISTORY VIEW */
        .history-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111827; z-index: 20; display: none; flex-direction: column; }
        .history-view.visible { display: flex; }
        .history-item { border-bottom: 1px solid #374151; padding: 12px; cursor: pointer; transition: background 0.2s; }
        .history-item:hover { background: #1F2937; }
        .save-badge { font-size: 0.7rem; color: #34D399; display: flex; align-items: center; gap: 4px; margin-top: 4px; opacity: 0; transition: opacity 0.5s; }
        .save-badge.visible { opacity: 1; }
    </style>
</head>
<body class="bg-gray-950 text-white font-sans min-h-screen p-4 md:p-6">

    <!-- HEADER & AUTH -->
    <div class="max-w-7xl mx-auto flex justify-between items-center mb-6 px-4">
        <div></div> <!-- Spacer -->
        <div class="flex items-center gap-4">
            <div id="auth-section">
                <button onclick="openAuthModal('login')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg transition font-medium shadow-lg flex items-center gap-2">
                    <i data-lucide="log-in" size="16"></i> Se connecter
                </button>
            </div>
            <div id="user-profile" class="hidden flex items-center gap-3 bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-700">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-xs font-bold" id="user-initials">U</div>
                <div class="text-sm">
                    <div class="font-medium" id="user-email-display">User</div>
                    <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300">D√©connexion</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6 pb-20">
        
        <!-- GAUCHE : Actifs -->
        <div class="lg:col-span-1 bg-gray-900 rounded-xl border border-gray-800 p-4 flex flex-col h-[85vh] sticky top-4">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-blue-500 flex items-center gap-2">
                    <i data-lucide="activity"></i> NovaTrade
                </h1>
                <p class="text-xs text-gray-500 mt-1">v8.8 Stability Patch</p>
            </div>

            <!-- ONGLETS DE NAVIGATION -->
            <div class="flex mb-4 border-b border-gray-700 space-x-1">
                <button onclick="switchCategory('crypto')" id="tab-crypto" class="flex-1 pb-2 text-xs font-medium active-tab transition">Crypto</button>
                <button onclick="switchCategory('stocks')" id="tab-stocks" class="flex-1 pb-2 text-xs font-medium inactive-tab transition">Actions</button>
                <button onclick="switchCategory('commodities')" id="tab-commodities" class="flex-1 pb-2 text-xs font-medium inactive-tab transition">Mati√®res</button>
            </div>

            <div id="asset-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2"></div>
            
            <div id="data-source-indicator" class="mt-4 pt-4 border-t border-gray-800 text-xs text-center text-gray-500">
                <p>Donn√©es March√© : API Directe</p>
                <p>Actualit√©s : <span class="text-green-400">Moteur Local</span></p>
            </div>
        </div>

        <!-- CENTRE : Graphiques -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- Header Actif -->
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-800 shadow-lg relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <h2 id="current-symbol" class="text-4xl font-bold">BTC</h2>
                        <p id="current-name" class="text-gray-400 text-sm">Bitcoin</p>
                    </div>
                    <div class="text-right">
                        <div id="main-price" class="text-4xl font-bold tracking-tight">--- ‚Ç¨</div>
                        <div id="main-change" class="text-lg font-medium mt-1">--- %</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-6 relative z-10">
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Haut 24h</span>
                        <div id="stat-high" class="font-mono text-green-400">---</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Bas 24h</span>
                        <div id="stat-low" class="font-mono text-red-400">---</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg">
                        <span class="text-gray-400 text-xs uppercase">Volume</span>
                        <div id="stat-vol" class="font-mono text-blue-400">---</div>
                    </div>
                </div>
            </div>

            <!-- Graphique -->
            <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 min-h-[300px]">
                <div class="relative h-64 w-full"><canvas id="mainChart"></canvas></div>
                <p class="text-[10px] text-gray-600 text-center mt-2" id="chart-disclaimer"></p>
            </div>

            <!-- Analyse Expert -->
            <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                <div class="bg-gray-800/50 p-4 border-b border-gray-700 flex items-center justify-between">
                    <h3 class="font-bold flex items-center gap-2 text-indigo-400">
                        <i data-lucide="brain-circuit"></i> Analyse Fondamentale
                    </h3>
                    <span class="text-xs text-gray-500 uppercase tracking-wider">M√©thode Gave / IDL</span>
                </div>
                <div class="p-5">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-indigo-900/50 flex items-center justify-center text-indigo-400 border border-indigo-500/30">
                                <i data-lucide="glasses" size="24"></i>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span id="analysis-signal" class="signal-badge signal-hold">...</span>
                                <span class="text-xs text-gray-500">Horizon: Long Terme</span>
                            </div>
                            <p id="analysis-text" class="text-gray-300 text-sm leading-relaxed italic">Chargement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DROITE : News -->
        <div class="lg:col-span-1 flex flex-col gap-6">
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold flex items-center gap-2 text-yellow-500">
                        <i data-lucide="rss" size="20"></i> Flux Presse Live
                    </h3>
                    <button onclick="generateOfflineNews()" class="p-1 rounded hover:bg-gray-700 text-gray-400 hover:text-white" title="Actualiser">
                        <i data-lucide="refresh-cw" size="14"></i>
                    </button>
                </div>
                <div id="news-feed" class="space-y-3 overflow-y-auto custom-scroll flex-1 pr-2"></div>
                <div class="mt-2 text-[10px] text-gray-600 text-center">Source: Agr√©gateur Local</div>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL & WIDGETS (STRUCTURE IDENTIQUE) -->
    <!-- ... Auth Modal and Chat Widget structures are identical to previous stable version ... -->
    <!-- Pour all√©ger le code affich√©, je r√©int√®gre les structures compl√®tes dans le script final -->
    
    <!-- AUTH MODAL -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" size="20"></i></button>
            <div id="login-form">
                <h2 class="text-2xl font-bold mb-6 text-white flex items-center gap-2"><i data-lucide="log-in"></i> Connexion</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm text-gray-400 mb-1">Email</label><input type="email" id="login-email" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 focus:outline-none"></div>
                    <div><label class="block text-sm text-gray-400 mb-1">Mot de passe</label><input type="password" id="login-pass" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 focus:outline-none"></div>
                    <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition">Se connecter</button>
                </div>
                <p class="text-sm text-gray-400 mt-4 text-center">Pas de compte ? <button onclick="toggleAuthMode('register')" class="text-blue-400 hover:underline">Cr√©er un compte</button></p>
            </div>
            <div id="register-form" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-white flex items-center gap-2"><i data-lucide="user-plus"></i> Inscription</h2>
                <div class="space-y-4">
                    <div><label class="block text-sm text-gray-400 mb-1">Email</label><input type="email" id="reg-email" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 focus:outline-none"></div>
                    <div><label class="block text-sm text-gray-400 mb-1">Mot de passe</label><input type="password" id="reg-pass" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 focus:outline-none"></div>
                    <div><label class="block text-sm text-gray-400 mb-1">Confirmation</label><input type="password" id="reg-pass-conf" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white focus:border-blue-500 focus:outline-none"></div>
                    <button onclick="initRegistration()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded transition">S'inscrire</button>
                </div>
                <p class="text-sm text-gray-400 mt-4 text-center">D√©j√† un compte ? <button onclick="toggleAuthMode('login')" class="text-purple-400 hover:underline">Se connecter</button></p>
            </div>
            <div id="verification-form" class="hidden text-center">
                <div class="mx-auto w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mb-4"><i data-lucide="mail-check" class="text-green-400" size="32"></i></div>
                <h2 class="text-2xl font-bold mb-2 text-white">V√©rification Email</h2>
                <p class="text-sm text-gray-400 mb-6">Un code √† 6 chiffres a √©t√© envoy√© √† <span id="verify-email-display" class="text-white font-mono">...</span></p>
                <div class="mb-6"><input type="text" id="verify-code" placeholder="Ex: 123456" maxlength="6" class="w-full text-center text-2xl tracking-widest bg-gray-800 border border-gray-700 rounded p-3 text-white focus:border-green-500 focus:outline-none"><p id="test-code-hint" class="text-xs text-yellow-400 mt-2 font-mono font-bold"></p></div>
                <button onclick="verifyCode()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition">Valider mon compte</button>
            </div>
        </div>
    </div>

    <!-- WIDGET CHATBOT -->
    <div class="chat-widget">
        <div class="chat-window" id="chatWindow">
            <div class="chat-header flex justify-between items-center">
                <div class="flex items-center gap-3"><div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg"><i data-lucide="bot" size="24" class="text-purple-600"></i></div><div><h4 class="font-bold text-white">NovaBot AI</h4><span class="text-xs text-purple-300 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full inline-block animate-pulse"></span> En ligne</span></div></div>
                <div class="flex items-center gap-2"><button onclick="toggleHistoryView()" class="text-purple-200 hover:text-white p-1 hover:bg-purple-800/50 rounded"><i data-lucide="history" size="20"></i></button><button onclick="toggleChat()" class="text-purple-200 hover:text-white p-1 hover:bg-purple-800/50 rounded"><i data-lucide="x" size="20"></i></button></div>
            </div>
            <div class="chat-messages custom-scroll" id="chatMessages"><div class="msg msg-bot">Bonjour ! Je suis <strong>NovaBot AI</strong>. ü§ñ<br><br>Je peux analyser le Bitcoin, les actions et les mati√®res premi√®res.<br><br>Essayez : "Faut-il acheter de l'Or ?"</div></div>
            <div id="historyView" class="history-view custom-scroll">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50"><h3 class="font-bold text-white">Historique</h3><button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1"><i data-lucide="trash-2" size="12"></i> Effacer tout</button></div>
                <div id="historyList" class="p-2 space-y-2"></div>
                <button onclick="toggleHistoryView()" class="m-4 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-sm">Retour au chat</button>
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-800"><form id="chatForm" onsubmit="handleChatSubmit(event)" class="flex gap-2"><input type="text" id="chatInput" placeholder="√âcrivez votre message..." autocomplete="off" class="flex-1 bg-gray-900 border border-gray-600 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500"><button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-xl transition shadow-lg flex items-center justify-center"><i data-lucide="send" size="20"></i></button></form></div>
        </div>
        <button onclick="toggleChat()" class="chat-button group"><i data-lucide="bot" size="32" class="text-white group-hover:rotate-12 transition-transform duration-300"></i></button>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ACTIFS ---
        const CRYPTO_ASSETS = [
            { symbol: 'BTC', pair: 'BTCEUR', name: 'Bitcoin', aliases: ['bitcoin', 'btc'] },
            { symbol: 'ETH', pair: 'ETHEUR', name: 'Ethereum', aliases: ['ethereum', 'eth'] },
            { symbol: 'SOL', pair: 'SOLEUR', name: 'Solana', aliases: ['solana', 'sol'] },
            { symbol: 'BNB', pair: 'BNBEUR', name: 'Binance Coin', aliases: ['bnb'] },
            { symbol: 'XRP', pair: 'XRPEUR', name: 'Ripple', aliases: ['xrp'] }
        ];

        const STOCK_ASSETS = [
            { symbol: 'AAPL', name: 'Apple Inc.', aliases: ['apple', 'aapl'] },
            { symbol: 'MSFT', name: 'Microsoft Corp', aliases: ['microsoft', 'msft'] },
            { symbol: 'GOOGL', name: 'Alphabet Inc.', aliases: ['google', 'googl'] },
            { symbol: 'TSLA', name: 'Tesla Inc.', aliases: ['tesla', 'tsla'] },
            { symbol: 'NVDA', name: 'NVIDIA Corp', aliases: ['nvidia', 'nvda'] },
            { symbol: 'META', name: 'Meta Platforms', aliases: ['meta', 'facebook'] },
            { symbol: 'AMZN', name: 'Amazon.com', aliases: ['amazon', 'amzn'] }
        ];

        const COMMODITY_ASSETS = [
            { symbol: 'GC=F', name: 'Or (Gold)', aliases: ['or', 'gold', 'xau'] },
            { symbol: 'SI=F', name: 'Argent (Silver)', aliases: ['argent', 'silver', 'xag'] },
            { symbol: 'CL=F', name: 'P√©trole (WTI)', aliases: ['petrole', 'oil', 'wti', 'brut'] },
            { symbol: 'NG=F', name: 'Gaz Naturel', aliases: ['gaz', 'gas', 'natgas'] },
            { symbol: 'HG=F', name: 'Cuivre (Copper)', aliases: ['cuivre', 'copper'] }
        ];

        const EXPERT_KNOWLEDGE = {
            'BTC': { signal: 'ACHETER', risk: 0.05, reason: "R√©serve de valeur anti-syst√®me.", context: "Monnaie hors d'atteinte des banques centrales." },
            'ETH': { signal: 'CONSERVER', risk: 0.03, reason: "Infrastructure Web3.", context: "Attention √† la volatilit√©." },
            'SOL': { signal: 'VENDRE', risk: 0, reason: "Trop centralis√©.", context: "Pr√©f√©rez la robustesse." },
            'AAPL': { signal: 'CONSERVER', risk: 0.04, reason: "Cash machine mais d√©pendante de la Chine.", context: "Attendre repli." },
            'MSFT': { signal: 'ACHETER', risk: 0.06, reason: "Monopole naturel Cloud/IA.", context: "Valeur de fond de portefeuille." },
            'TSLA': { signal: 'VENDRE', risk: 0, reason: "Marges en baisse.", context: "Trop cher." },
            'GC=F': { signal: 'ACHETER', risk: 0.10, reason: "L'assurance ultime.", context: "L'Or est roi." },
            'SI=F': { signal: 'ACHETER', risk: 0.05, reason: "M√©tal industriel.", context: "Forte demande solaire." },
            'CL=F': { signal: 'CONSERVER', risk: 0.03, reason: "G√©opolitique tendue.", context: "Risque r√©cession." },
            'NG=F': { signal: 'VENDRE', risk: 0, reason: "Volatilit√© extr√™me.", context: "R√©serv√© aux pros." },
            'HG=F': { signal: 'CONSERVER', risk: 0.02, reason: "Indicateur √©conomique.", context: "Si la Chine ralentit, le cuivre chute." },
            'DEFAULT': { signal: 'NEUTRE', risk: 0.02, reason: "Manque de visibilit√©.", context: "Restez liquide." }
        };

        let currentCategory = 'crypto';
        let currentAsset = CRYPTO_ASSETS[0];
        let currentPriceCache = 0; 
        let currentChangeCache = 0;
        let myChart = null;
        let defaultCapital = 10000;
        let currentUser = null;
        let NEWS = [];

        // --- FONCTION CL√â POUR L'AFFICHAGE HEADER ---
        function renderAssetDetails() {
            document.getElementById('current-symbol').innerText = currentAsset.symbol;
            document.getElementById('current-name').innerText = currentAsset.name;
            
            const ana = EXPERT_KNOWLEDGE[currentAsset.symbol] || EXPERT_KNOWLEDGE.DEFAULT;
            const sig = document.getElementById('analysis-signal');
            if (sig) {
                sig.innerText = ana.signal;
                sig.className = `signal-badge ${ana.signal === 'ACHETER' ? 'signal-buy' : (ana.signal === 'VENDRE' ? 'signal-sell' : 'signal-hold')}`;
                document.getElementById('analysis-text').innerText = ana.reason;
            }
        }

        // --- MOTEUR NEWS LOCAL ---
        function generateOfflineNews() {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isUp = currentChangeCache >= 0;
            const trendWord = isUp ? "progresse" : "corrige";
            
            const cryptoNews = [
                { t: `Le ${currentAsset.name} ${trendWord} face √† l'incertitude macro`, s: "CoinDesk" },
                { t: "R√©gulation : L'Europe pr√©cise son cadre pour les actifs num√©riques", s: "Les Echos" }
            ];
            const stockNews = [
                { t: `March√©s : Le titre ${currentAsset.name} sous surveillance`, s: "Bloomberg" },
                { t: "Wall Street ouvre en ordre dispers√©", s: "Reuters" }
            ];
            const commoNews = [
                { t: "Mati√®res Premi√®res : Tensions sur l'approvisionnement", s: "OilPrice" },
                { t: "L'Or confirme son statut de valeur refuge", s: "Kitco" }
            ];

            let source = currentCategory === 'crypto' ? cryptoNews : (currentCategory === 'stocks' ? stockNews : commoNews);
            
            NEWS = source.map(i => ({
                title: i.t,
                source: i.s + " ‚Ä¢ " + time,
                impact: isUp ? "Positif" : "Neutre",
                url: "https://www.google.com/search?q=" + encodeURIComponent(i.t)
            }));
            
            renderNews();
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            // APPEL EXPLICITE DE L'UPDATE HEADER
            renderAssetDetails();

            if (currentCategory === 'crypto') {
                document.getElementById('chart-disclaimer').innerText = "";
                await fetchBinance(currentAsset.pair);
            } else {
                document.getElementById('chart-disclaimer').innerText = "* Donn√©es Yahoo Finance (Proxy).";
                await fetchYahoo(currentAsset.symbol);
            }
        }

        async function fetchBinance(s) {
            try {
                const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${s}`);
                if(!r.ok) throw new Error('Binance Error');
                const d = await r.json();
                currentPriceCache = parseFloat(d.lastPrice);
                currentChangeCache = parseFloat(d.priceChangePercent);
                updateUI(d.lastPrice, d.priceChangePercent, d.highPrice, d.lowPrice, d.volume);
                
                const k = await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=1h&limit=24`);
                const kd = await k.json();
                renderChart(kd.map(x=>new Date(x[0]).getHours()+'h'), kd.map(x=>parseFloat(x[4])));
            } catch(e) { console.warn("Binance fetch failed", e); }
        }

        async function fetchYahoo(s) {
            try {
                // Utilisation AllOrigins qui est plus permissif sur les headers
                const u = `https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=60m&range=1d&_=${Date.now()}`;
                const r = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent(u));
                if(!r.ok) throw new Error('Proxy Error');
                
                const json = await r.json();
                const d = JSON.parse(json.contents);
                if(!d.chart || !d.chart.result) throw new Error('Yahoo format error');

                const res = d.chart.result[0];
                const meta = res.meta;
                const p = meta.regularMarketPrice;
                const c = ((p - meta.chartPreviousClose)/meta.chartPreviousClose)*100;
                
                currentPriceCache = p;
                currentChangeCache = c;
                updateUI(p, c, meta.regularMarketDayHigh, meta.regularMarketDayLow, meta.regularMarketVolume);
                
                const ts = res.timestamp || [];
                const qs = res.indicators.quote[0].close || [];
                const cd = ts.map((t,i)=>({t,c:qs[i]})).filter(x=>x.c!=null).slice(-24);
                renderChart(cd.map(x=>new Date(x.t*1000).getHours()+'h'), cd.map(x=>x.c));
            } catch(e) { 
                console.warn("Yahoo fetch failed", e);
                updateUI(0, 0, 0, 0, 0); // Reset UI on error
            }
        }

        function updateUI(p,c,h,l,v) {
            const el = document.getElementById('main-price');
            const curr = currentCategory === 'crypto' ? 'EUR' : 'USD';
            el.innerText = (p === 0 || isNaN(p)) ? '---' : new Intl.NumberFormat('en-US', { style: 'currency', currency: curr }).format(p);
            
            document.getElementById('main-change').innerText = (c === 0 || isNaN(c)) ? '---' : (c>0?'+':'') + parseFloat(c).toFixed(2) + '%';
            document.getElementById('main-change').className = `text-lg font-medium mt-1 ${c>=0?'text-green-400':'text-red-400'}`;
            document.getElementById('stat-high').innerText = isNaN(h) ? '---' : parseFloat(h).toFixed(2);
            document.getElementById('stat-low').innerText = isNaN(l) ? '---' : parseFloat(l).toFixed(2);
            document.getElementById('stat-vol').innerText = v ? (v>1000000?(v/1000000).toFixed(2)+'M':v) : 'N/A';
        }

        function renderChart(l,d) {
            if(myChart) myChart.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');
            const col = d.length > 0 && d[d.length-1]>=d[0] ? '#10B981' : '#EF4444';
            const grad = ctx.createLinearGradient(0,0,0,300); grad.addColorStop(0, col+'33'); grad.addColorStop(1, 'rgba(0,0,0,0)');
            myChart = new Chart(ctx, { type:'line', data:{labels:l, datasets:[{data:d, borderColor:col, backgroundColor:grad, borderWidth:2, pointRadius:0, fill:true, tension:0.4}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:false}, scales:{x:{display:false}, y:{position:'right', grid:{color:'#374151'}} }, interaction:{intersect:false, mode:'index'}} });
        }

        // --- UI LOGIC ---
        function switchCategory(c) {
            currentCategory = c;
            document.getElementById('tab-crypto').className = `flex-1 pb-2 text-xs font-medium transition ${c==='crypto'?'active-tab':'inactive-tab'}`;
            document.getElementById('tab-stocks').className = `flex-1 pb-2 text-xs font-medium transition ${c==='stocks'?'active-tab':'inactive-tab'}`;
            document.getElementById('tab-commodities').className = `flex-1 pb-2 text-xs font-medium transition ${c==='commodities'?'active-tab':'inactive-tab'}`;
            
            if(c==='crypto') currentAsset = CRYPTO_ASSETS[0];
            else if(c==='stocks') currentAsset = STOCK_ASSETS[0];
            else currentAsset = COMMODITY_ASSETS[0];
            
            renderAssetList();
            fetchData();
            generateOfflineNews();
        }

        function renderAssetList() {
            const listEl = document.getElementById('asset-list'); listEl.innerHTML='';
            let items = currentCategory === 'crypto' ? CRYPTO_ASSETS : (currentCategory === 'stocks' ? STOCK_ASSETS : COMMODITY_ASSETS);
            items.forEach(a => {
                const b = document.createElement('button');
                b.className = `asset-btn w-full text-left p-3 rounded-lg border border-gray-700 hover:bg-gray-800 transition flex justify-between items-center ${a.symbol===currentAsset.symbol?'active':'bg-gray-800/40 text-gray-300'}`;
                b.onclick = () => { 
                    currentAsset=a; 
                    renderAssetList(); // Update active state
                    renderAssetDetails(); // IMMEDIATE UI UPDATE
                    fetchData(); 
                    generateOfflineNews(); 
                };
                b.innerHTML = `<div><div class="font-bold">${a.name}</div><div class="text-xs opacity-70">${a.symbol}</div></div>`;
                listEl.appendChild(b);
            });
        }

        function renderNews() {
            const c = document.getElementById('news-feed');
            c.innerHTML = '';
            NEWS.forEach(n => {
                const color = n.impact === 'Positif' ? 'text-green-400' : (n.impact === 'N√©gatif' ? 'text-red-400' : 'text-gray-400');
                const div = document.createElement('div');
                div.onclick = () => window.open(n.url, '_blank');
                div.className = "bg-gray-800 p-3 rounded border-l-4 border-gray-600 block hover:bg-gray-700 transition duration-200 cursor-pointer mb-2";
                div.style.borderColor = n.impact === 'Positif' ? '#10B981' : (n.impact === 'N√©gatif' ? '#EF4444' : '#9CA3AF');
                div.innerHTML = `<div class="flex justify-between text-xs text-gray-500 mb-1"><span class="text-blue-400 font-semibold flex items-center gap-1">${n.source} <i data-lucide="external-link" size="10"></i></span></div><h4 class="text-sm font-medium text-gray-200 mb-1 leading-snug">${n.title}</h4><span class="text-xs ${color} font-bold uppercase">${n.impact}</span>`;
                c.appendChild(div);
            });
            lucide.createIcons();
        }

        // Re-integration des fonctions Auth/Chat/History (non modifi√©es mais n√©cessaires)
        function initAuth() { const s=localStorage.getItem('nova_session'); if(s){ currentUser=JSON.parse(s); updateAuthUI(); } }
        function openAuthModal(m) { document.getElementById('auth-modal').classList.add('open'); toggleAuthMode(m); }
        function closeAuthModal() { document.getElementById('auth-modal').classList.remove('open'); }
        function toggleAuthMode(m) { 
            ['login-form','register-form','verification-form'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            if(m==='login') document.getElementById('login-form').classList.remove('hidden');
            else if(m==='register') document.getElementById('register-form').classList.remove('hidden');
            else document.getElementById('verification-form').classList.remove('hidden');
        }
        function handleLogin() { 
            const e=document.getElementById('login-email').value, p=document.getElementById('login-pass').value;
            const u=JSON.parse(localStorage.getItem('nova_users')||'[]').find(x=>x.email===e && x.password===p);
            if(u) { currentUser=u; localStorage.setItem('nova_session',JSON.stringify(u)); updateAuthUI(); closeAuthModal(); if(document.getElementById('historyView').classList.contains('visible')) loadHistory(); } 
            else alert("Erreur identifiants");
        }
        function initRegistration() {
            const e=document.getElementById('reg-email').value, p=document.getElementById('reg-pass').value, c=document.getElementById('reg-pass-conf').value;
            if(!e||!p) return alert("Champs vides");
            if(p!==c) return alert("Mots de passe diff√©rents");
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            localStorage.setItem('nova_temp_reg', JSON.stringify({email:e, password:p, code:code}));
            alert("Code: "+code);
            document.getElementById('verify-email-display').innerText=e;
            document.getElementById('test-code-hint').innerText="Code: "+code;
            toggleAuthMode('verification');
        }
        function verifyCode() {
            const c=document.getElementById('verify-code').value, t=JSON.parse(localStorage.getItem('nova_temp_reg'));
            if(t && c===t.code) {
                const users=JSON.parse(localStorage.getItem('nova_users')||'[]');
                const u={id:Date.now(), email:t.email, password:t.password};
                users.push(u); localStorage.setItem('nova_users',JSON.stringify(users));
                currentUser=u; localStorage.setItem('nova_session',JSON.stringify(u));
                updateAuthUI(); closeAuthModal(); alert("Compte cr√©√© !");
            } else alert("Code incorrect");
        }
        function logout() { currentUser=null; localStorage.removeItem('nova_session'); updateAuthUI(); }
        function updateAuthUI() {
            if(currentUser) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('user-profile').classList.remove('hidden');
                document.getElementById('user-profile').classList.add('flex');
                document.getElementById('user-email-display').innerText=currentUser.email.split('@')[0];
                document.getElementById('user-initials').innerText=currentUser.email[0].toUpperCase();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('user-profile').classList.add('hidden');
                document.getElementById('user-profile').classList.remove('flex');
            }
        }
        function toggleChat() { const w=document.getElementById('chatWindow'); w.classList.toggle('open'); if(w.classList.contains('open')) setTimeout(()=>document.getElementById('chatInput').focus(),300); }
        function handleChatSubmit(e) {
            e.preventDefault(); const i=document.getElementById('chatInput'); const t=i.value.trim(); if(!t)return;
            addMessage('user', t); i.value='';
            setTimeout(() => {
                const r = generateLocalSmartResponse(t);
                addMessage('bot', r);
                if(currentUser) {
                    const k=`nova_chat_history_${currentUser.id}`, h=JSON.parse(localStorage.getItem(k)||'[]');
                    h.unshift({timestamp:new Date().toISOString(), userMessage:t, botResponse:r});
                    localStorage.setItem(k,JSON.stringify(h));
                }
            }, 600);
        }
        function addMessage(r,h) {
            const d=document.createElement('div'); d.className=`msg ${r==='user'?'msg-user':'msg-bot'}`; d.innerHTML=h;
            const c=document.getElementById('chatMessages'); c.appendChild(d); c.scrollTop=9999;
        }
        function generateLocalSmartResponse(t) {
            const l=t.toLowerCase();
            if(l.includes('combien')) return `<strong>üí∞ Conseil</strong><br>Allocation max conseill√©e : 5% du capital.`;
            return `<strong>üîé Analyse</strong><br>Je surveille ${currentAsset.name}.`;
        }
        function toggleHistoryView() { 
            const v=document.getElementById('historyView'); v.classList.toggle('visible');
            if(v.classList.contains('visible')) {
                const l=document.getElementById('historyList'); l.innerHTML='';
                if(!currentUser) return l.innerHTML='<p class="text-center text-gray-500 text-xs mt-4">Connectez-vous.</p>';
                const h=JSON.parse(localStorage.getItem(`nova_chat_history_${currentUser.id}`)||'[]');
                if(!h.length) return l.innerHTML='<p class="text-center text-gray-500 text-xs mt-4">Vide.</p>';
                h.forEach(x=>{
                    const d=document.createElement('div'); d.className='history-item bg-gray-800/50 p-2 rounded mb-2 text-xs';
                    d.innerHTML=`<div class="text-gray-500">${new Date(x.timestamp).toLocaleDateString()}</div><div class="text-white">Me: ${x.userMessage}</div>`;
                    l.appendChild(d);
                });
            }
        }
        function clearHistory() { if(currentUser && confirm("Effacer ?")) { localStorage.removeItem(`nova_chat_history_${currentUser.id}`); toggleHistoryView(); toggleHistoryView(); } }

        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            renderAssetList();
            generateOfflineNews();
            fetchData();
            setInterval(fetchData, 10000);
            setInterval(generateOfflineNews, 900000);
        });
    </script>
</body>
</html>
